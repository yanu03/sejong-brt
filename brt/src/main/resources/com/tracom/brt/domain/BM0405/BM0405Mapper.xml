<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tracom.brt.domain.BM0405.BM0405Mapper">

    <select id="BM0405G0S0" parameterType="String" resultType="bmRoutInfoVO">
		SELECT
			  ROUT_ID
		    , ROUT_NM
            , ST_STA_NM
            , ED_STA_NM
		    , WAY_DIV
            , USER_WAY_DIV
            , TURN_DIV
		    , SHORT_ROUT_NM
		    , DATE_FORMAT(UPDATED_AT, '%Y-%m-%d %H:%i:%s') AS UPDATED_AT
		FROM
			BM_ROUT_INFO
		<where>
			<if test="value != null">
				ROUT_ID LIKE CONCAT('%', #{value}, '%')
			    OR
			    ROUT_NM LIKE CONCAT('%', #{value}, '%')
	    	</if>
		</where>
    </select>
    
    <select id="BM0405G1S0" parameterType="voiceOrganizationVO" resultType="bmRoutNodeInfoVO">
		SELECT
			  NI.STA_ID
			, NI.SEQ
			, NI.LATI
		    , NI.LONGI
			, IFNULL(SI.STA_NM, NI.NODE_NM) AS NODE_NM
			, SI.STA_ID
		    , SI.STA_NM
		    , SI.STA_NO
		    , SI.UPDATED_AT
		FROM
			BM_ROUT_NODE_INFO NI
		    LEFT OUTER JOIN
			BM_STA_INFO SI
		    ON NI.STA_ID = SI.STA_ID
		WHERE
			ROUT_ID = #{routId}
			AND SI.STA_ID IS NOT NULL
			<!-- <if test="value != null">
				AND(
				NI.STA_ID LIKE CONCAT('%', #{filter1}, '%')
				OR
				SI.STA_NM LIKE CONCAT('%', #{filter1}, '%')
				OR
				SI.STA_NO LIKE CONCAT('%', #{filter1}, '%')
				)
	    	</if> -->
		ORDER BY SEQ
    </select>
    
    <select id="BM0405G2S0" parameterType="voiceOrganizationVO" resultType="voiceOrganizationVO">
		SELECT
			  ORGA_ID
			, ORGA_NM
			, LATI
			, LONGI
			, ALL_PLAY_TM
			, REMARK
			, STA_ID
		FROM
			BM_VOC_ORGA
		WHERE
			ROUT_ID = #{routId}
    </select>
    
    <select id="BM0405G3S0" parameterType="String" resultType="voiceInfoVO">
    	SELECT
    		  V.VOC_ID
    		, V.VOC_NM
    		, V.PLAY_TYPE
    		, V.PLAY_TM
    		, V.VOC_DIV
    		, D.DL_CD_NM AS VOC_DIV_NM
    		, IF(DATE_FORMAT(NOW(), '%Y-%m-%d') > V.PLAY_ED_DATE, 'Y', 'N') IS_DEADLINE
    	FROM
    		BM_VOC_INFO V
    		LEFT OUTER JOIN SM_DL_CD_INFO D
    		ON V.VOC_DIV = D.DL_CD
    	WHERE
    		V.VOC_DIV = #{value}
    </select>
    
    <select id="BM0405G4S0" parameterType="String" resultType="voiceInfoVO">
    	SELECT
    		  O.VOC_ID
    		, V.VOC_NM
    		, D.DL_CD_NM AS VOC_DIV_NM
    		, IF(DATE_FORMAT(NOW(), '%Y-%m-%d') > V.PLAY_ED_DATE, 'Y', 'N') IS_DEADLINE
    	FROM
    		BM_VOC_ORGA_LIST O
    		LEFT OUTER JOIN BM_VOC_INFO V
    		ON O.VOC_ID = V.VOC_ID
    		LEFT OUTER JOIN SM_DL_CD_INFO D
    		ON V.VOC_DIV = D.DL_CD
    	WHERE
    		O.ORGA_ID = #{value}  
    </select>
    
    <insert id="BM0405G2I0" parameterType="voiceOrganizationVO">
    	<selectKey keyProperty="orgaId" resultType="String" order="BEFORE">
    		SELECT CONCAT('AG', LPAD(NEXTVAL(SEQ_BM_VOC_ORGA_0), 7, '0'))
    	</selectKey>
    	
    	INSERT INTO BM_VOC_ORGA(
    		  ORGA_ID
    		, ORGA_NM
    		, LATI
    		, LONGI
    		, ALL_PLAY_TM
    		, REMARK
    		, ROUT_ID
    		, STA_ID
    		, CREATED_AT
    		, CREATED_BY
    		, CREATED_IP
    		, UPDATED_AT
    		, UPDATED_BY
    		, UPDATED_IP)
   		VALUES
   		(
   			  #{orgaId}
   			, #{orgaNm}
   			, #{lati}
   			, #{longi}
   			, #{allPlayTm}
   			, #{remark}
   			, #{routId}
   			, #{staId}
   			, #{createdAt}
   			, #{createdBy}
   			, #{createdIp}
   			, #{updatedAt}
   			, #{updatedBy}
   			, #{updatedIp}
   		)
    </insert>
    
    <insert id="BM0405G2I1" parameterType="voiceOrganizationVO">
    
    	INSERT INTO BM_VOC_ORGA_LIST(
    		  ORGA_ID
    		, VOC_ID
    	)
    	VALUES
    	<foreach collection="orgaList" item="item" separator=",">
    	(
    		  #{orgaId}
    		, #{item.vocId}
    	)
    	</foreach>
    </insert>
    
    <update id="BM0405F0U0" parameterType="voiceOrganizationVO">
    	UPDATE BM_VOC_ORGA
    	SET
    		  ORGA_NM		= #{orgaNm}
    		, LATI			= #{lati}
    		, LONGI			= #{longi}
    		, ALL_PLAY_TM	= #{allPlayTm}
    		, REMARK		= #{remark}
    		, STA_ID		= #{staId}
    		, UPDATED_AT	= #{updatedAt}
    		, UPDATED_BY	= #{updatedBy}
    		, UPDATED_IP	= #{updatedIp}
    	WHERE
    		ORGA_ID = #{orgaId}
    </update>
    
    <delete id="BM0405G2D0" parameterType="voiceOrganizationVO">
    	DELETE
    		FROM BM_VOC_ORGA
    	WHERE
    		ORGA_ID = #{orgaId}
    </delete>
    
    <delete id="BM0405G2D1" parameterType="voiceOrganizationVO">
    	DELETE
    		FROM BM_VOC_ORGA_LIST
    	WHERE
    		ORGA_ID = #{orgaId}
    </delete>
</mapper>